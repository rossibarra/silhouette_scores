---
title: "sims"
output:
  html_document: default
  pdf_document: default
  bibliography: bibliography.bib
---

# Simulations

We've discussed some concerns about the analysis and interpretation of [@MorenoLetelier]. Here I'd like to do a wee bit of simulation to provide an intuition for some of these issues.  I don't show all the packages and code here for sake of brevity, but all the code is available in a [github repository](https://github.com/rossibarra/silhouette_scores.git) if interested.  This should not be considered in any way a formal analysis, as I am making assumptions about demography and the topology of the tree representing population history, running only a few simulations, ignoring linked selection, simulating only a small region of the genome, and by no means rigorously testing alternative scenarios. 

```{r, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(cowplot)
library(admixturegraph)
library(neldermead)
library(doParallel)
library(parallel)
library(foreach)
library(LEA)
library(pbapply)
library(cluster)
library(viridis)
source("plotting_funcs.R")
```

We simulate 6 populations, following a tree something like this:

```{r set tree, echo=FALSE}
leaves <- c("SA", "MH", "ML","P1","P2","ME")
inner_nodes <- c("P", "M", "SM","PX","AN")
edges <- parent_edges(c(edge("P1", "AN"),
                        edge("AN","P"),
                        edge("P2", "P"),
                        edge("ML", "M"),
                        edge("MH", "M"),                          
                        edge("M","SM"),
                        edge("SA","SM"),
                        edge("SM","AN"),
                        edge("P","PX"),
                        edge("ME","PX")
                        ))
graph <- agraph(leaves, inner_nodes, edges)
make_an_outgroup(graph, "ME")
plot(graph, show_inner_node_labels = TRUE, show_admixture_labels = TRUE)
```

Where **ME** is *Z. mays* ssp. *mexicana*, **P1** and **P2** are two populations of *Z. mays* ssp. *mexicana* (representing e.g. Jalisco and Balsas populations), and **ML**, **MH**, and **SA** are Mexican Highland, Mexican Lowland, and a South American population of domesticated *Z. mays* ssp. *mays*. We are showing maize as having been domesticated from **P1**. I won't go into the details of the demography I'm using, except to say I think it should be a reasonable (cartoonish) approximation for what we think maize and teosinte population sizes and split times are.  For details of how demography works on this commandline see [the documentation for ms](http://home.uchicago.edu/rhudson1/source/mksamples.html) and several relevant papers [ross2009historical; takuno; wright; tenaillon; eyre-walker ]. The notable detail for which we have no data is the split time between populations **P1** and **P2**; here I'm assuming it's on the same order of magnitude as the split time between **ME** and **P1**.

Here we use msprime [@kelleher2016efficient] to generate coalescent simulations for these populations. We simulate $\Theta=4N_e\mu=18,000$ which, with a maize mutation rate of $3\times10^{-8}$ [@clark2005estimating] and a teosinte effective population size of $N_e=150,000$ [ross2009historical] is equivalent to about 1Mb of sequence.  For convenience we set the recombination rate $\rho=4N_ec=\Theta$. 

First, our generic function to run simulations and then generate diploid samples:
```{r functions}
gendata<-function(migration_command,n,ninds){
  hapdat<-matrix(unlist(lapply(strsplit(system(paste("mspms ", n*ninds, " 1 -t 180 -r 180 180 -I ", n, " ", paste(rep(ninds,n),collapse=" ") , " ", migration_command, " | tail -", n*ninds,sep=""),intern=T),''),as.numeric)),nrow=n*ninds,byrow=T) # run coalescent sim

paste(c(rep(ninds,n),rep(0,2)))
  
  genodat<-hapdat[seq(1,n*ninds,2),]+hapdat[seq(2,n*ninds,2),] # make diploid 
  
  write.table(t(genodat),file="./crap.geno", quote=F, row.names=F, col.names=F, sep="") #write genotype file
  return(genodat) #rows=sites, columns=individuals
}
```

We run a simulation with no migration, with population splits following the topology in Figure 1 [].
```{r sim migration}
npops=6
ninds=20
kpops=6

migration_command=paste("-n 4 3 -n 5 3 -n 6 3 -g 4 205 -g 5 300 -g 6 300 -ej 0.0075 5 4 -en 0.0075 4 0.32 -ej 0.011 6 4 -en 0.011 4 0.11 -ej 0.015 4 1 -en 0.015 1 1 -ej 0.08 3 1 -en 0.08 1 1 -ej 0.1 2 1 -en 0.1 1 1")
mydat_nada<-gendata(migration_command,npops,ninds)
```

Now we run one where there *is* migration, 

```{r sim nothing}
migration_command=paste("-n 4 3 -n 5 3 -n 6 3 -g 4 205 -g 5 300 -g 6 300 -ej 0.0075 5 4 -en 0.0075 4 0.32 -ej 0.011 6 4 -en 0.011 4 0.11 -ej 0.015 4 1 -en 0.015 1 1 -ej 0.08 3 1 -en 0.08 1 1 -ej 0.1 2 1 -en 0.1 1 1")

mydat_migration<-gendata(migration_command,npops,ninds)
```


#### Allele counts
```{r counts}
mydat<-mydat_nada
allele_counts=list()
allele_freqs=list()
cumulative=0
rmpop=as.numeric()
for(i in 1:(npops)){
  sample=1:(ninds/2)
  if(length(sample)==0){  
      allele_counts[[i]]=paste(0,0,sep=",")
      allele_freqs[[i]]=paste(0,0,sep=",")
      rmpop=c(rmpop,i)
  } else if(length(sample)==1) {
    allele_counts[[i]]=paste(mydat[cumulative+sample,],2*length(sample)-mydat[cumulative+sample,],sep=",")
    allele_freqs[[i]]=mydat[cumulative+sample,]/(2*length(sample))
  }
  else{
    allele_counts[[i]]=paste(colSums(mydat[cumulative+sample,]),2*length(sample)-colSums(mydat[cumulative+sample,]),sep=",")
    allele_freqs[[i]]=colSums(mydat[cumulative+sample,])/(2*length(sample))
  }
  cumulative=cumulative+max(sample)
}
```

## Structure Plots

#### Uncut
```{r uncut structure}
#structure on original
obj.snmf<-snmf("./crap.geno",K = kpops, repetitions=1, CPU=2, alpha = 10, project = "new") 
qmatrix = Q(obj.snmf, K = kpops)
bobuncut=gather(data.frame(t(qmatrix)),dude,qval,1:(nrow(qmatrix))) %>%
mutate(pop=factor(rep(1:kpops,nrow(qmatrix))),dude=factor(as.numeric(gsub("X","",dude))))
```


#### Plots
```{r structure plots,fig.height=3, fig.width=12, results="hide"}
blank2=c(rep("",9))
blank1=c()
poplabs=c(blank1,"PA",blank2,blank1,"ME",blank2,blank1,"ML",blank2,blank1,"SL",blank2,blank1,"SH",blank2,blank1,"MH",blank2)

ggplot(bobuncut,aes(x=dude,y=qval,fill=pop))+
    geom_bar(stat="identity")+
    theme(
      axis.text.y=element_blank(),
      axis.ticks.y=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank()
    )+
    ggtitle("ADMIXTURE")+
    scale_fill_manual(guide=FALSE,values=viridis(npops))+
    scale_x_discrete(labels=poplabs)+
    theme(axis.text=element_text(size=32),plot.title = element_text(size = 40, face = "bold"))
```

## Treemix
```{r treemix og}
treemix<-data.frame(matrix(unlist(allele_counts),ncol=npops,byrow=F))
colnames(treemix)=c("PARV","MEX","ML","SL","SH","MH")
write.table(treemix,"treemix_input.txt",quote=F,row.name=F)
system("gzip -f treemix_input.txt")
```

Make tree
```{r make uncut tree}
system("~/src/treemix/src/treemix -i ~/gdrive/sandbox/silhouette/treemix_input.txt.gz -o treemix_out -m 1 -root MEX")
plot_tree("~/gdrive/sandbox/silhouette/treemix_out")
```
